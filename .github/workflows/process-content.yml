name: Process New Content

on:
  issues:
    types: [opened, edited]
  workflow_dispatch:  # Allows manual triggering

permissions:
  contents: write
  issues: read

jobs:
  process-content:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'
      
      - name: Create directories if they don't exist
        run: |
          mkdir -p data
          mkdir -p art
          mkdir -p photos
          mkdir -p journal
          mkdir -p cat
      
      - name: Create empty data files if they don't exist
        run: |
          [ -f data/art.json ] || echo '{"items":[]}' > data/art.json
          [ -f data/photos.json ] || echo '{"items":[]}' > data/photos.json
          [ -f data/journal.json ] || echo '{"items":[]}' > data/journal.json
          [ -f data/cat.json ] || echo '{"items":[]}' > data/cat.json
      
      - name: Process issue content
        if: github.event_name == 'issues'
        run: |
          # Create issue data file
          echo '${{ toJSON(github.event.issue) }}' > issue_data.json
          
          # Create processing script
          cat > process-issue.js << 'EOF'
          const fs = require('fs');

          // Read the issue data
          const issueData = JSON.parse(fs.readFileSync('issue_data.json', 'utf8'));

          // Get basic info
          const title = issueData.title;
          const body = issueData.body;
          const createdAt = issueData.created_at;
          const labels = issueData.labels || [];

          // Determine content type from title or labels
          let contentType = 'art'; // Default to art
          if (title.toLowerCase().includes('[photo]') || labels.some(l => l.name.toLowerCase() === 'photo')) contentType = 'photos';
          if (title.toLowerCase().includes('[journal]') || labels.some(l => l.name.toLowerCase() === 'journal')) contentType = 'journal';
          if (title.toLowerCase().includes('[cat]') || labels.some(l => l.name.toLowerCase() === 'cat')) contentType = 'cat';

          // Format date
          const date = new Date(createdAt);
          const formattedDate = `${date.getDate().toString().padStart(2, '0')}.${(date.getMonth()+1).toString().padStart(2, '0')}.${date.getFullYear()}`;

          // Create ID from title
          const cleanTitle = title.replace(/\[[^\]]+\]/g, '').trim();
          const id = cleanTitle.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]+/g, '');

          // Extract fields from body
          function extractField(body, fieldName) {
            const regex = new RegExp(`### ${fieldName}\\s+([^#]*?)(?=###|$)`, 's');
            const match = body.match(regex);
            return match ? match[1].trim() : '';
          }

          const description = extractField(body, 'Description');
          const content = extractField(body, 'Content');
          const image = extractField(body, 'Image URL \\(optional\\)');

          // Create the new item
          const newItem = {
            id: id,
            title: cleanTitle,
            date: formattedDate,
            description: description || null,
            content: content,
            image: image || null,
            url: `${contentType}/${id}.html`
          };

          // Read existing data
          const dataPath = `data/${contentType}.json`;
          let data = { items: [] };

          if (fs.existsSync(dataPath)) {
            try {
              data = JSON.parse(fs.readFileSync(dataPath, 'utf8'));
            } catch (error) {
              console.log(`Error reading ${dataPath}. Creating new file.`);
            }
          }

          // Add new item (or update existing one with same ID)
          const existingIndex = data.items.findIndex(item => item.id === id);
          if (existingIndex >= 0) {
            data.items[existingIndex] = newItem;
          } else {
            data.items.unshift(newItem); // Add to beginning (newest first)
          }

          // Write updated data
          fs.writeFileSync(dataPath, JSON.stringify(data, null, 2));

          // Create HTML file
          const htmlContent = `<!DOCTYPE html>
          <html>
          <head>
              <title>${cleanTitle} | ART ARCHIVE</title>
              <style>
                  body {
                      background-color: #f8f8f8;
                      font-family: "Lucida Console", Monaco, monospace;
                      margin: 0;
                      padding: 20px;
                      color: #222222;
                      max-width: 800px;
                      margin: 0 auto;
                  }
                  
                  h1 {
                      font-size: 20px;
                      margin-bottom: 5px;
                      text-transform: uppercase;
                  }
                  
                  .date {
                      color: #666;
                      font-size: 12px;
                      margin-bottom: 20px;
                  }
                  
                  .description {
                      color: #444;
                      font-style: italic;
                      margin-bottom: 20px;
                  }
                  
                  .content {
                      line-height: 1.6;
                      margin-top: 20px;
                  }
                  
                  .image {
                      margin: 20px 0;
                  }
                  
                  .footer {
                      margin-top: 30px;
                      font-size: 11px;
                      color: #666;
                      border-top: 1px solid #ccc;
                      padding-top: 10px;
                  }
                  
                  a {
                      color: #000;
                      text-decoration: none;
                  }
                  
                  a:hover {
                      text-decoration: underline;
                  }
              </style>
          </head>
          <body>
              <h1>${cleanTitle}</h1>
              <div class="date">${formattedDate}</div>
              ${description ? `<div class="description">${description}</div>` : ''}
              ${image ? `<div class="image"><img src="${image}" alt="${cleanTitle}" style="max-width:100%;"></div>` : ''}
              <div class="content">
                  ${content.replace(/\n/g, '<br>')}
              </div>
              <div class="footer">
                  <a href="/">← back to archive</a>
              </div>
          </body>
          </html>`;

          fs.writeFileSync(`${contentType}/${id}.html`, htmlContent);
          console.log(`Created/updated entry: ${cleanTitle} (${contentType}/${id}.html)`);
          EOF
          
          # Run the processing script
          node process-issue.js
      
      - name: Create sample content for manual runs
        if: github.event_name == 'workflow_dispatch'
        run: |
          # Create a new sample entry
          echo '{
            "items": [
              {
                "id": "sample-artwork",
                "title": "Sample Artwork",
                "date": "01.06.2024",
                "description": "Acrylic on canvas, 18×24\"",
                "content": "This is a sample artwork created to test the system.",
                "image": "https://placehold.co/600x400?text=Sample+Artwork",
                "url": "art/sample-artwork.html"
              }
            ]
          }' > data/art.json
          
          # Create the HTML file
          echo '<!DOCTYPE html>
          <html>
          <head>
              <title>Sample Artwork | ART ARCHIVE</title>
              <style>
                  body {
                      background-color: #f8f8f8;
                      font-family: "Lucida Console", Monaco, monospace;
                      margin: 0;
                      padding: 20px;
                      color: #222222;
                      max-width: 800px;
                      margin: 0 auto;
                  }
                  
                  h1 {
                      font-size: 20px;
                      margin-bottom: 5px;
                      text-transform: uppercase;
                  }
                  
                  .date {
                      color: #666;
                      font-size: 12px;
                      margin-bottom: 20px;
                  }
                  
                  .description {
                      color: #444;
                      font-style: italic;
                      margin-bottom: 20px;
                  }
                  
                  .content {
                      line-height: 1.6;
                      margin-top: 20px;
                  }
                  
                  .image {
                      margin: 20px 0;
                  }
                  
                  .footer {
                      margin-top: 30px;
                      font-size: 11px;
                      color: #666;
                      border-top: 1px solid #ccc;
                      padding-top: 10px;
                  }
                  
                  a {
                      color: #000;
                      text-decoration: none;
                  }
                  
                  a:hover {
                      text-decoration: underline;
                  }
              </style>
          </head>
          <body>
              <h1>Sample Artwork</h1>
              <div class="date">01.06.2024</div>
              <div class="description">Acrylic on canvas, 18×24"</div>
              <div class="image"><img src="https://placehold.co/600x400?text=Sample+Artwork" alt="Sample Artwork" style="max-width:100%;"></div>
              <div class="content">
                  This is a sample artwork created to test the system.
              </div>
              <div class="footer">
                  <a href="/">← back to archive</a>
              </div>
          </body>
          </html>' > art/sample-artwork.html
      
      - name: Commit changes
        uses: EndBug/add-and-commit@v9
        with:
          message: 'Update content'
          add: '.'
          default_author: github_actions
